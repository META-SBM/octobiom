---
title: "Exploratory analysis"
output: html_document
---

```{r}
library(octobiom)
library(dplyr)
```
#Load data
Data for practice is collected in data folder. Let's load them.
```{r}
data(ps)
force(ps)
```
#Palletes
The package provides several color palettes that can be both displayed and loaded into the environment. The user can also use their own color palettes
```{r}
octobiom::show_palette('set_10_2')
color_palette <- octobiom::get_palette("set_10_2")
knitr::include_graphics('./figures/palette.png',dpi=300)
```
#Metadata
We provide the ability to evaluate the distribution of metadata in a single figure. Variables can be either continuous or categorical. You only need to provide the names of the columns of interest.
```{r,fig.height=8}
?octobiom::plot_metadata_distributions
features <- c('bmi','bmi_group','age_at_baseline','age_group','sex',
              "kidney.disease","chronic_bronchitis","smoking_status","YEAR",
              "diabetes" ,"tuberculosis" )

#You can change number of rows and cols in  combined plot
octobiom::plot_metadata_distributions(ps,features = features,color_palette = color_palette,nrow =3,ncol = 4)
```
#Prepare phyloseq
When working with tables we often need to preprocess the data.Microbial data are often transformed ( compositional,clr), but not necessarily. Rare taxa are also filtered out. The package includes the ability to adjust whether you filter the count data first or transform the data and then filter. Agglomeration of data to the required taxonomic level is done at the beginning
We'll do the filtering first, then we'll transform it.
```{r,fig.height=4,fig.width=1}
?octobiom::prepare_phyloseq
ps_obj <- octobiom::prepare_phyloseq(ps,transformation = 'compositional',detection = 10,prev = 0.05,taxonomic_level = 'Species',first = 'filter')
knitr::include_graphics('./figures/pipeline_prepare_phyloseq.png',dpi=300)

```
#HEATMAP
It is recommended to evaluate the structure of the data before analysis to exclude bad samples.Heatmap helps to estimate possible outliers and evaluate the structure of the data. The heatmap can also show the distribution of features across samples. We will use metadata like year, bmi, age and sex. Only categorical features can be transmitted.

```{r,fig.height=12}
ps_obj <- octobiom::prepare_phyloseq(ps,transformation = 'clr',detection = 10,prev = 0.05,taxonomic_level = 'Species',
                                     first = 'filter')
?octobiom::generate_microbiome_heatmap
features <- c('bmi_group','age_group','sex',
              "smoking_status","YEAR" )
phylum_colors <- c(
  'Euryarchaeota'              = "#001219" ,
  'Thaumarchaeota'             = "#005f73" ,
  'Actinobacteria'             = "#0a9396" ,
  'Bacteria_unclassified'      = "#94d2bd" ,
  'Bacteroidetes'              = "#e9d8a6" ,
  'Candidatus_Melainabacteria' = "#ee9b00" ,
  'Candidatus_Saccharibacteria'= "#ca6702" ,
  'Firmicutes'                 = "#bb3e03" ,
  'Fusobacteria'               = "#ae2012" ,
  'Lentisphaerae'              = "#9b2226" ,
  'Proteobacteria'             = '#F55B66' ,
  'Synergistetes'              = '#ACACAC' ,
  'Tenericutes'                = '#5CD5DA' ,
  'Verrucomicrobia'            = '#0089DF' ,
  'Ascomycota'                 = '#19427D'
)
YEAR_colors <- c(
  '2017' = "#D5B3FF",
  '2022' = "#FBD960"
)
bmi_colors <- c(
  'Lean' = "#FF8400",
  'Overweight' = "#3C096C",
  'Obesity' = "#FF0A54"
)
age_colors <- c(
  '37-45'='#48cae4',#blue
  '46-55' = '#a24f7c' ,
  '56-65'='#ff6b35',#orange
  '65+' = '#ef233c' #red
)
sex_colors <- c(
    'female'='#ff5c8a',
    'male' = '#0466c8'
  )
smoking_status_colors <- c(
  'Never a smoker' = '#a7c957',
  'No, ex-smoker' = '#b80c09',
  "Yes, a current smoker" = '#0b4f6c'
)

octobiom::generate_microbiome_heatmap(ps_obj,tax_level_annotation = 'Phylum',features = features,
                                      tax_colors = list('Phylum' = phylum_colors),
                                               feature_colors = list('YEAR' = YEAR_colors,'bmi_group' = bmi_colors,
                                                                     'age_group' = age_colors,'sex' = sex_colors,
                                                                     'smoking_status' = smoking_status_colors))
```

#PERMANOVA
To estimate the contribution of metadata to the microbiome variance , we will use the PERMANOVA test.
```{r,fig.width=10,fig,fig.height=5}
?plot_permanova
ps_obj <- octobiom::prepare_phyloseq(ps,transformation = 'compositional',detection = 10,prev = 0.05,taxonomic_level = 'Species',
                                     first = 'filter')
formula <- 'YEAR + bmi_group + age_group + sex + smoking_status'
#For the function to work correctly, you need to define attributes in a category and create a technical column
cols_meta <- data.frame(
  category = c('sociodemographic','sociodemographic','sociodemographic','behavioral\n factors','technical'), 
  row.names = c("sex",'age_group','bmi_group','smoking_status','YEAR'))
cols_meta$new_name <- rownames(cols_meta)
category_order <- c('comorbidities','sociodemographic','behavioral\n factors','technical')

# Reorder the factor levels in cols_meta
cols_meta$category <- factor(cols_meta$category, levels = category_order)
color_palette <- octobiom::get_palette("set_10_3")
permanova_results <- octobiom::plot_permanova(ps_obj,formula = formula, method = 'bray',cols_meta = cols_meta,palette = color_palette )

```
#Alpha
There are many views in ecology and microbiology about how best to characterize biological diversity. One of the most common approaches is to estimate Î±-diversity, which reflects the species richness and evenness of distribution of species within a community. We provide the ability to calculate the Gini-Simpson, Shannon, chao1 index. In the first two cases, composite data is required. Therefore, the indices are calculated separately and then combined. You can pass either one variable for study or several
```{r,fig.height=5}
ps_obj <- octobiom::prepare_phyloseq(ps,transformation = 'compositional',detection = 100,prev = 0.05,taxonomic_level = 'Species',
                                     first = 'filter')
?octobiom::create_alpha_plots
#Let's analyze alpha diversity
features <- c('bmi_group','age_group')
color_palette <- octobiom::get_palette("set_10_4")
plot_alpha_list <- purrr::map(features, ~ {
  tryCatch({
    octobiom::create_alpha_plots(ps_obj, col= .x, colors = color_palette,measure = c("Shannon",'Simpson'))
  }, error = function(e) {
    message(paste("Error in method:", .x))
    message(e$message)  # Print the error message
    return(NULL)  # Return NULL for this iteration
  })
})
ps_obj <- octobiom::prepare_phyloseq(ps,transformation = 'NONE',detection = 100,prev = 0.05,taxonomic_level = 'Species',
                                     first = 'filter')
plot_alpha_list_chao <- purrr::map(features, ~ {
  tryCatch({
    octobiom::create_alpha_plots(ps_obj, col= .x, colors = color_palette,measure = c("Chao1"))
  }, error = function(e) {
    message(paste("Error in method:", .x))
    message(e$message)  # Print the error message
    return(NULL)  # Return NULL for this iteration
  })
})


ggpubr::ggarrange(plot_alpha_list[[1]]$plots,plot_alpha_list_chao[[1]]$plots,widths = c(2,1))
ggpubr::ggarrange(plot_alpha_list[[2]]$plots,plot_alpha_list_chao[[2]]$plots,widths = c(2,1))
```
#Beta
When comparing two communities or assessing changes in a single community with an emphasis on similarities or differences in species composition, it is useful to use beta diversity analysis. This analysis characterizes the degree of difference or similarity between habitats based on their species composition and quantitative distribution of species. The first function allows you to plot one feature, while the second function allows you to plot 2 features on one figure.
```{r,fig.height=8,fig.width=12}
ps_obj <- octobiom::prepare_phyloseq(ps,transformation = 'clr',detection = 10,prev = 0.1,taxonomic_level = 'Species',
                                     first = 'filter')

ps_obj@sam_data$bmi_group <- factor(ps_obj@sam_data$bmi_group,levels = c('Lean','Overweight','Obesity'))
ps_obj@sam_data$age_group <- factor(ps_obj@sam_data$age_group,levels = c('37-45','46-55','56-65','65+'))
palette_list <- list(
   'bmi_group' = bmi_colors,
   'age_group' = age_colors
 )
?octobiom::create_ordination_plots
#Let's analyze beta diversity
features <- c('bmi_group','age_group')
color_palette <- octobiom::get_palette("set_10_4")

plot_beta_list <- purrr::map(features, ~ {
  tryCatch({
    octobiom::create_ordination_plots(ps_obj, group= .x, 
                                      distance_method = "euclidean",palette = color_palette,taxa_plot = FALSE)
  }, error = function(e) {
    message(paste("Error in method:", .x))
    message(e$message)  # Print the error message
    return(NULL)  # Return NULL for this iteration
  })
})

?octobiom::create_ordination_plots_double
db <- octobiom::create_ordination_plots_double(ps_obj,
                                     group = 'bmi_group',
                                     palette = palette_list$bmi_group,distance_method = 'euclidean',
                                     additional_group = 'age_group',
                                     shape_palette = c(1,2,3,4),
                                     additional_palette = palette_list$age_group)

one_beta <- octobiom::create_ordination_plots_double(ps_obj,
                                     group = 'bmi_group',
                                     palette = palette_list$bmi_group,distance_method = 'euclidean'
                                     )
```
#stacked barplot hierarchical
```{r,fig.height=8}
ps_obj <- octobiom::prepare_phyloseq(ps,transformation = 'compositional',detection = 10,prev = 0.1,taxonomic_level = 'Species',
                                     first = 'filter')
?octobiom::barplot_hierarchical
#Creates a stacked barplot of taxonomic compositions with hierarchical clustering dendrogram and sample metadata annotations for top taxa.
features <- c('bmi_group','age_group','sex',"YEAR" )
color_palette <- octobiom::get_palette("set_20_2")
color_palette <- c('white',color_palette)
colors_annotation <- list('YEAR' = YEAR_colors,'bmi_group' = bmi_colors,
                                                                     'age_group' = age_colors,'sex' = sex_colors)
octobiom::barplot_hierarchical(ps_obj,taxrank="Species", top = 20, feature = features,
                                      dist = 'bray',colors_barplot = color_palette,
                                   colors_annotation = colors_annotation,decreasing = T,
                                   size = c(0.5,0.2,0.2,0.2,0.2,5))

```
#correlation between features and taxa
```{r,fig.height=4}
?octobiom::prepare_phyloseq

ps_obj <- octobiom::prepare_phyloseq(ps,transformation = 'clr',detection = 10,prev = 0.10,taxonomic_level = 'Species',
                                     first = 'filter')

feature_colors <- c(
  "age_at_baseline" = "#ff9999",
  "bmi" = "#99ccff"
)
?build_multi_correlation_network
network_correlation_results <- octobiom::build_multi_correlation_network(
  ps_obj,
  features = c("age_at_baseline", "bmi"),
  tax_rank = "Species",
  cor_method = 'pearson',
  feature_colors = feature_colors
)
network_correlation_results
```

